//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////
///			Copyright 2021 (C) Bruno Xavier B. Leite
//////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#include "IMagicNodeSharp.h"
#include "MagicNodeSharp.h"

#include "Runtime/Core/Public/Misc/App.h"
#include "Runtime/Core/Public/Misc/Paths.h"

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#define LOCTEXT_NAMESPACE "Synaptech"

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void FMagicNodeSharp::StartupModule() {
	IPlatformFile &PlatformManager = FPlatformFileManager::Get().GetPlatformFile();
	//
	CS_SCRIPT_DIR = FPaths::Combine(*FPaths::ConvertRelativePathToFull(FPaths::GameSourceDir()),TEXT("Scripts"));
	CS_DATA_DIR = FPaths::Combine(*FPaths::ConvertRelativePathToFull(FPaths::ProjectDir()),TEXT("Intermediate/Managed"));
	//
	#ifdef MCS_MARKETPLACE_BUILD
	  static FString DIRxCFG = FPaths::Combine(*FPaths::EnginePluginsDir(),TEXT("Marketplace"),CS_PLUGIN_NAME,TEXT("Binaries"));
	#else
	 static FString DIRxCFG = FPaths::Combine(*FPaths::ProjectPluginsDir(),CS_PLUGIN_NAME,TEXT("Binaries"));
	#endif
	//
	static FString DIRxUEN = FPaths::Combine(*DIRxCFG,TEXT("UnrealEngine.dll"));
	static FString DIRxDOM = FPaths::Combine(*DIRxCFG,TEXT("MagicNode.dll"));
	//
	static FString BINxUEN = FPaths::Combine(*CS_BINARY_DIR,TEXT("UnrealEngine.dll"));
	static FString BINxDOM = FPaths::Combine(*CS_BINARY_DIR,TEXT("MagicNode.dll"));
	//
	//
	#if WITH_EDITOR
	if (!PlatformManager.DirectoryExists(*CS_SCRIPT_DIR)) {
		PlatformManager.CreateDirectory(*CS_SCRIPT_DIR);
	}///
	//
	if (!PlatformManager.DirectoryExists(*CS_DATA_DIR)) {
		PlatformManager.CreateDirectory(*CS_DATA_DIR);
	}///
	//
	if (!PlatformManager.DirectoryExists(*CS_BINARY_DIR)) {
		PlatformManager.CreateDirectory(*CS_BINARY_DIR);
	}///
	//
	check(PlatformManager.CopyFile(*BINxUEN,*DIRxUEN));
	check(PlatformManager.CopyFile(*BINxDOM,*DIRxDOM));
	#endif
	//
	#ifdef MCS_NOT_SUPPORTED
		LOG::CS(EScriptSeverity::Fatal,TEXT("C# 'Magic Node' plugin is currently not supported on target platform!"));
	#else
		MonoCore_INIT();
	#endif
}

void FMagicNodeSharp::ShutdownModule() {
	#if !WITH_EDITOR
	MonoCore_STOP();
	#endif
}

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#undef LOCTEXT_NAMESPACE

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

IMPLEMENT_GAME_MODULE(FMagicNodeSharp,MagicNodeSharp);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////